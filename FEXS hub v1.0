local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FEXSGUIHub"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- Main Frame (Draggable)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 280, 0, 190) -- Increased height to fit new buttons
MainFrame.Position = UDim2.new(0.5, -140, 0.3, -80)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = true

-- Rainbow background setup
local hue = 0
RunService.RenderStepped:Connect(function(dt)
	hue = (hue + dt * 0.2) % 1
	MainFrame.BackgroundColor3 = Color3.fromHSV(hue, 0.8, 0.9)
end)

-- Title bar
local TitleBar = Instance.new("TextLabel")
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TitleBar.BorderSizePixel = 0
TitleBar.Text = "FEXS GUI Hub"
TitleBar.TextColor3 = Color3.new(1,1,1)
TitleBar.Font = Enum.Font.SourceSansBold
TitleBar.TextSize = 22
TitleBar.Parent = MainFrame

-- Close Button
local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 40, 0, 30)
CloseBtn.Position = UDim2.new(1, -40, 0, 0)
CloseBtn.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.new(1,1,1)
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.TextSize = 20
CloseBtn.Parent = MainFrame

-- Open Button
local OpenBtn = Instance.new("TextButton")
OpenBtn.Size = UDim2.new(0, 120, 0, 30)
OpenBtn.Position = UDim2.new(0, 10, 0.5, -15)
OpenBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
OpenBtn.BorderSizePixel = 0
OpenBtn.Text = "Open FEXS GUI"
OpenBtn.TextColor3 = Color3.new(1,1,1)
OpenBtn.Font = Enum.Font.SourceSansBold
OpenBtn.TextSize = 18
OpenBtn.Visible = false
OpenBtn.Parent = ScreenGui

-- Open/Close functionality
CloseBtn.MouseButton1Click:Connect(function()
	MainFrame.Visible = false
	OpenBtn.Visible = true
end)

OpenBtn.MouseButton1Click:Connect(function()
	MainFrame.Visible = true
	OpenBtn.Visible = false
end)

-- Speed Button
local SpeedBtn = Instance.new("TextButton")
SpeedBtn.Size = UDim2.new(0, 240, 0, 45)
SpeedBtn.Position = UDim2.new(0, 20, 0, 50)
SpeedBtn.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
SpeedBtn.BorderSizePixel = 0
SpeedBtn.TextColor3 = Color3.new(1,1,1)
SpeedBtn.Font = Enum.Font.SourceSans
SpeedBtn.TextSize = 20
SpeedBtn.Parent = MainFrame

-- Speed settings
local speeds = {"Normal", "Fast", "Very Fast"}
local speedValues = { Normal = 16, Fast = 40, ["Very Fast"] = 80 }
local currentSpeedIndex = 1

local function updateSpeed()
	local speedName = speeds[currentSpeedIndex]
	SpeedBtn.Text = "Speed: " .. speedName
	local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
	if humanoid then
		humanoid.WalkSpeed = speedValues[speedName]
	end
end

SpeedBtn.MouseButton1Click:Connect(function()
	currentSpeedIndex = currentSpeedIndex + 1
	if currentSpeedIndex > #speeds then
		currentSpeedIndex = 1
	end
	updateSpeed()
end)

updateSpeed()

-- ===== ESP Buttons and Logic =====

-- ESP State Variables
local espEnabled = false
local nameTagsEnabled = false
local tracersEnabled = false
local espBoxes = {}
local nameTags = {}
local tracers = {}

-- ESP Toggle Button
local ESPBtn = Instance.new("TextButton")
ESPBtn.Size = UDim2.new(0, 240, 0, 35)
ESPBtn.Position = UDim2.new(0, 20, 0, 105)
ESPBtn.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
ESPBtn.BorderSizePixel = 0
ESPBtn.TextColor3 = Color3.new(1,1,1)
ESPBtn.Font = Enum.Font.SourceSans
ESPBtn.TextSize = 18
ESPBtn.Text = "ESP: OFF"
ESPBtn.Parent = MainFrame

-- Name Tags Toggle Button
local NameTagBtn = Instance.new("TextButton")
NameTagBtn.Size = UDim2.new(0, 115, 0, 30)
NameTagBtn.Position = UDim2.new(0, 20, 0, 145)
NameTagBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
NameTagBtn.BorderSizePixel = 0
NameTagBtn.TextColor3 = Color3.new(1,1,1)
NameTagBtn.Font = Enum.Font.SourceSans
NameTagBtn.TextSize = 16
NameTagBtn.Text = "Name Tags: OFF"
NameTagBtn.Parent = MainFrame

-- Tracers Toggle Button
local TracerBtn = Instance.new("TextButton")
TracerBtn.Size = UDim2.new(0, 115, 0, 30)
TracerBtn.Position = UDim2.new(0, 145, 0, 145)
TracerBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
TracerBtn.BorderSizePixel = 0
TracerBtn.TextColor3 = Color3.new(1,1,1)
TracerBtn.Font = Enum.Font.SourceSans
TracerBtn.TextSize = 16
TracerBtn.Text = "Tracers: OFF"
TracerBtn.Parent = MainFrame

-- Function to create ESP for a player
local function createESP(player)
	if player == LocalPlayer then return end
	if espBoxes[player] then return end

	local character = player.Character or player.CharacterAdded:Wait()
	local root = character:WaitForChild("HumanoidRootPart", 5)
	local head = character:WaitForChild("Head", 5)
	local humanoid = character:FindFirstChildOfClass("Humanoid")

	if not root or not head then return end

	-- Box ESP
	local box = Instance.new("BoxHandleAdornment")
	box.Name = "ESPBox"
	box.Adornee = character
	box.Size = Vector3.new(4, 6, 2)
	box.AlwaysOnTop = true
	box.ZIndex = 5
	box.Transparency = 0.6
	box.Color3 = Color3.new(1, 0, 0) -- Red by default
	box.Parent = game:GetService("CoreGui")
	espBoxes[player] = box

	-- Name Tag
	local tag = Instance.new("BillboardGui")
	tag.Name = "NameTag"
	tag.Adornee = head
	tag.Size = UDim2.new(0, 200, 0, 50)
	tag.StudsOffset = Vector3.new(0, 2.5, 0)
	tag.AlwaysOnTop = true
	tag.Enabled = nameTagsEnabled
	tag.Parent = game:GetService("CoreGui")

	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, 0, 1, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = player.Name
	nameLabel.TextColor3 = Color3.new(1, 1, 1)
	nameLabel.TextSize = 14
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.Parent = tag
	nameTags[player] = tag

	-- Tracer line (using Drawing API)
	local line = Drawing.new("Line")
	line.Thickness = 1.5
	line.Color = Color3.new(1, 1, 1)
	line.Visible = tracersEnabled
	tracers[player] = line
end

-- Remove ESP for player
local function removeESP(player)
	if espBoxes[player] then
		espBoxes[player]:Destroy()
		espBoxes[player] = nil
	end
	if nameTags[player] then
		nameTags[player]:Destroy()
		nameTags[player] = nil
	end
	if tracers[player] then
		tracers[player]:Remove()
		tracers[player] = nil
	end
end

-- Enable ESP for all players
local function enableESP()
	for _, player in pairs(Players:GetPlayers()) do
		createESP(player)
	end
end

-- Disable ESP for all players
local function disableESP()
	for _, player in pairs(Players:GetPlayers()) do
		removeESP(player)
	end
end

-- Update Tracers every frame
RunService.RenderStepped:Connect(function()
	for player, line in pairs(tracers) do
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and line then
			local root = player.Character.HumanoidRootPart
			local camera = workspace.CurrentCamera
			local screenPos, onScreen = camera:WorldToViewportPoint(root.Position)
			line.Visible = onScreen and tracersEnabled
			if line.Visible then
				line.From = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y)
				line.To = Vector2.new(screenPos.X, screenPos.Y)
			end
		end
	end
end)

-- ESP Button Click
ESPBtn.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	if espEnabled then
		ESPBtn.Text = "ESP: ON"
		enableESP()
	else
		ESPBtn.Text = "ESP: OFF"
		disableESP()
	end
end)

-- Name Tag Button Click
NameTagBtn.MouseButton1Click:Connect(function()
	nameTagsEnabled = not nameTagsEnabled
	NameTagBtn.Text = nameTagsEnabled and "Name Tags: ON" or "Name Tags: OFF"
	for _, tag in pairs(nameTags) do
		if tag then
			tag.Enabled = nameTagsEnabled
		end
	end
end)

-- Tracer Button Click
TracerBtn.MouseButton1Click:Connect(function()
	tracersEnabled = not tracersEnabled
	TracerBtn.Text = tracersEnabled and "Tracers: ON" or "Tracers: OFF"
end)

-- Handle new players joining
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function()
		if espEnabled then
			wait(1)
			createESP(player)
		end
	end)
end)

-- Handle players leaving
Players.PlayerRemoving:Connect(function(player)
	removeESP(player)
end)
