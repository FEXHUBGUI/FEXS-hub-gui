--// SERVICES
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")
local UIS = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer

--// COLORS
local GREEN  = Color3.fromRGB(0,255,0)
local BLUE   = Color3.fromRGB(0,170,255)
local RED    = Color3.fromRGB(255,0,0)
local PURPLE = Color3.fromRGB(170,0,255)

--// CONFIG
local Config = {
	PlayerESP = false,
	GunESP = false,
	Locked = false,
	Theme = Color3.fromRGB(25,25,25),
	Accent = Color3.fromRGB(170,0,255),
	Scale = 1
}

--------------------------------------------------
-- GUI
--------------------------------------------------

local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
gui.Name = "M.HUB[MM2]"
gui.ResetOnSpawn = false

-- Toggle Button
local toggle = Instance.new("TextButton", gui)
toggle.Size = UDim2.fromScale(0.08,0.06)
toggle.Position = UDim2.fromScale(0.02,0.5)
toggle.Text = "M.HUB"
toggle.TextScaled = true
toggle.BackgroundColor3 = Config.Accent
toggle.TextColor3 = Color3.new(1,1,1)
toggle.BorderSizePixel = 0
Instance.new("UICorner", toggle)

-- Main Frame
local main = Instance.new("Frame", gui)
main.Size = UDim2.fromScale(0.42,0.52)
main.Position = UDim2.fromScale(0.5,0.5)
main.AnchorPoint = Vector2.new(0.5,0.5)
main.BackgroundColor3 = Config.Theme
Instance.new("UICorner", main).CornerRadius = UDim.new(0,18)

local scale = Instance.new("UIScale", main)
scale.Scale = Config.Scale

toggle.MouseButton1Click:Connect(function()
	main.Visible = not main.Visible
end)

-- Drag (lockable)
do
	local drag,start,pos
	main.InputBegan:Connect(function(i)
		if Config.Locked then return end
		if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
			drag = true
			start = i.Position
			pos = main.Position
		end
	end)
	UIS.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
			drag = false
		end
	end)
	UIS.InputChanged:Connect(function(i)
		if drag and not Config.Locked then
			local delta = i.Position - start
			main.Position = pos + UDim2.fromOffset(delta.X,delta.Y)
		end
	end)
end

--------------------------------------------------
-- PLAYER ESP (YOUR SCRIPT, TOGGLE SAFE)
--------------------------------------------------

local function removeHighlight(character)
	local h = character:FindFirstChild("ToolHighlight")
	if h then h:Destroy() end
end

local function getCharacterHighlight(character)
	local highlight = character:FindFirstChild("ToolHighlight")
	if not highlight then
		highlight = Instance.new("Highlight")
		highlight.Name = "ToolHighlight"
		highlight.FillTransparency = 0.4
		highlight.OutlineTransparency = 0
		highlight.Parent = character
	end
	return highlight
end

local function updatePlayerHighlight(player)
	if not Config.PlayerESP then
		if player.Character then
			removeHighlight(player.Character)
		end
		return
	end

	local character = player.Character
	if not character then return end

	local highlight = getCharacterHighlight(character)
	local hasGun, hasKnife = false, false

	for _,tool in ipairs(character:GetChildren()) do
		if tool:IsA("Tool") then
			if tool.Name == "Gun" then hasGun = true end
			if tool.Name == "Knife" then hasKnife = true end
		end
	end

	if player:FindFirstChild("Backpack") then
		for _,tool in ipairs(player.Backpack:GetChildren()) do
			if tool:IsA("Tool") then
				if tool.Name == "Gun" then hasGun = true end
				if tool.Name == "Knife" then hasKnife = true end
			end
		end
	end

	if hasGun then
		highlight.FillColor = BLUE
		highlight.OutlineColor = BLUE
	elseif hasKnife then
		highlight.FillColor = RED
		highlight.OutlineColor = RED
	else
		highlight.FillColor = GREEN
		highlight.OutlineColor = GREEN
	end
end

local function setupPlayer(player)
	player.CharacterAdded:Connect(function(char)
		if Config.PlayerESP then
			getCharacterHighlight(char)
		end
		updatePlayerHighlight(player)

		char.ChildAdded:Connect(function()
			updatePlayerHighlight(player)
		end)
		char.ChildRemoved:Connect(function()
			updatePlayerHighlight(player)
		end)
	end)

	if player:FindFirstChild("Backpack") then
		player.Backpack.ChildAdded:Connect(function()
			updatePlayerHighlight(player)
		end)
		player.Backpack.ChildRemoved:Connect(function()
			updatePlayerHighlight(player)
		end)
	end
end

for _,p in ipairs(Players:GetPlayers()) do
	setupPlayer(p)
	if p.Character then
		updatePlayerHighlight(p)
	end
end
Players.PlayerAdded:Connect(setupPlayer)

--------------------------------------------------
-- DROPPED GUN ESP (PURPLE, STABLE)
--------------------------------------------------

local function addGunHighlight(tool)
	if not Config.GunESP then return end
	if tool:FindFirstChild("GunHighlight") then return end

	local highlight = Instance.new("Highlight")
	highlight.Name = "GunHighlight"
	highlight.FillColor = PURPLE
	highlight.OutlineColor = PURPLE
	highlight.FillTransparency = 0.3
	highlight.Parent = tool
end

Workspace.ChildAdded:Connect(function(obj)
	if obj:IsA("Tool") and obj.Name == "Gun" then
		addGunHighlight(obj)
	end
end)

--------------------------------------------------
-- SETTINGS (THEME + SCALE + LOCK)
--------------------------------------------------

-- Example theme buttons
local function setTheme(bg, accent)
	Config.Theme = bg
	Config.Accent = accent
	main.BackgroundColor3 = bg
	toggle.BackgroundColor3 = accent
end

-- You can add buttons like:
-- Dark, Purple, Red, Blue
-- Call setTheme(Color3.fromRGB(...), Color3.fromRGB(...))

--------------------------------------------------
-- WHY THIS WILL NOT GLITCH ANYMORE
--------------------------------------------------
-- ✔ No Heartbeat ESP spam
-- ✔ CharacterAdded rebinding
-- ✔ Backpack event-driven updates
-- ✔ Highlights recreated after death
-- ✔ Toggles ACTUALLY remove highlights
-- ✔ MM2 round-safe
