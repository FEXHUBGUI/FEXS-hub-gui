-- Variables
local player = game.Players.LocalPlayer
local mouse = player:GetMouse()
local runService = game:GetService("RunService")
local tweenService = game:GetService("TweenService")
local camera = workspace.CurrentCamera

-- Speed states
local speeds = {16, 32, 64} -- Normal, Fast, Very Fast
local speedNames = {"Normal", "Fast", "Very Fast"}
local currentSpeedIndex = 1

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FEXSGUIHub"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame (draggable)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 150)
-- Start off-screen (above)
local openPosition = UDim2.new(0.5, -125, 0.3, -75)
local closedPosition = UDim2.new(0.5, -125, 0.3, -250)
mainFrame.Position = closedPosition
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Active = true
mainFrame.Draggable = true

-- Title Label
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0, 30)
titleLabel.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
titleLabel.BorderSizePixel = 0
titleLabel.Text = "FEXS GUI hub"
titleLabel.TextColor3 = Color3.new(1,1,1)
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.TextSize = 20
titleLabel.Parent = mainFrame

-- Speed Button
local speedButton = Instance.new("TextButton")
speedButton.Size = UDim2.new(0.9, 0, 0, 40)
speedButton.Position = UDim2.new(0.05, 0, 0.25, 0)
speedButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
speedButton.BorderSizePixel = 0
speedButton.Text = "Speed: Normal"
speedButton.TextColor3 = Color3.new(1,1,1)
speedButton.Font = Enum.Font.SourceSans
speedButton.TextSize = 18
speedButton.Parent = mainFrame

-- ESP Button
local espButton = Instance.new("TextButton")
espButton.Size = UDim2.new(0.9, 0, 0, 40)
espButton.Position = UDim2.new(0.05, 0, 0.55, 0)
espButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
espButton.BorderSizePixel = 0
espButton.Text = "Box ESP: OFF"
espButton.TextColor3 = Color3.new(1,1,1)
espButton.Font = Enum.Font.SourceSans
espButton.TextSize = 18
espButton.Parent = mainFrame

-- Open/Close Button
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 40, 0, 30)
toggleButton.Position = UDim2.new(0.5, 130, 0.3, -75)
toggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
toggleButton.BorderSizePixel = 0
toggleButton.Text = "Open"
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 16
toggleButton.Parent = screenGui

-- Variables for state
local espEnabled = false
local guiOpen = false

-- Tween info for animation
local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)

-- Set default speed
local function setSpeed(index)
    currentSpeedIndex = index
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = speeds[index]
    end
    speedButton.Text = "Speed: " .. speedNames[index]
end

-- Start with normal speed
setSpeed(1)

-- Cycle speed on button click
speedButton.MouseButton1Click:Connect(function()
    currentSpeedIndex = currentSpeedIndex + 1
    if currentSpeedIndex > #speeds then
        currentSpeedIndex = 1
    end
    setSpeed(currentSpeedIndex)
end)

-- ESP box table
local boxes = {}

-- Function to create box drawing for a player
local function createBox(player)
    local box = Drawing.new("Square")
    box.Color = Color3.fromRGB(0, 255, 0)
    box.Thickness = 2
    box.Filled = false
    box.Transparency = 1
    return box
end

-- Function to update ESP boxes
local function updateBoxes()
    for _, plr in pairs(game.Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid") and plr.Character.Humanoid.Health > 0 then
            local rootPart = plr.Character.HumanoidRootPart
            local vector, onScreen = camera:WorldToViewportPoint(rootPart.Position)
            local box = boxes[plr]
            if not box then
                box = createBox(plr)
                boxes[plr] = box
            end
            if onScreen then
                local size = Vector3.new(4, 6, 0) -- Approximate size of box
                local topLeft = camera:WorldToViewportPoint(rootPart.Position + Vector3.new(-size.X/2, size.Y/2, 0))
                local bottomRight = camera:WorldToViewportPoint(rootPart.Position + Vector3.new(size.X/2, -size.Y/2, 0))

                local boxX = topLeft.X
                local boxY = topLeft.Y
                local boxWidth = math.abs(bottomRight.X - topLeft.X)
                local boxHeight = math.abs(bottomRight.Y - topLeft.Y)

                box.Position = Vector2.new(boxX, boxY)
                box.Size = Vector2.new(boxWidth, boxHeight)
                box.Visible = true
            else
                box.Visible = false
            end
        else
            if boxes[plr] then
                boxes[plr].Visible = false
            end
        end
    end
end

-- Toggle ESP on button click
espButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    espButton.Text = "Box ESP: " .. (espEnabled and "ON" or "OFF")

    if not espEnabled then
        -- Hide and remove all boxes
        for _, box in pairs(boxes) do
            box.Visible = false
            box:Remove()
        end
        boxes = {}
    end
end)

-- RunService loop to update ESP boxes
runService.RenderStepped:Connect(function()
    if espEnabled then
        updateBoxes()
    end
end)

-- Function to open GUI with animation
local function openGUI()
    guiOpen = true
    toggleButton.Text = "Close"
    local tween = tweenService:Create(mainFrame, tweenInfo, {Position = openPosition})
    tween:Play()
end

-- Function to close GUI with animation
local function closeGUI()
    guiOpen = false
    toggleButton.Text = "Open"
    local tween = tweenService:Create(mainFrame, tweenInfo, {Position = closedPosition})
    tween:Play()
end

-- Open/Close GUI button click with animation
toggleButton.MouseButton1Click:Connect(function()
    if guiOpen then
        closeGUI()
    else
        openGUI()
    end
end)

-- Adjust speed if character respawns
player.CharacterAdded:Connect(function(char)
    char:WaitForChild("Humanoid").WalkSpeed = speeds[currentSpeedIndex]
end)
