--// Universal GUI Script with Tabs, Open/Close, Animations + Fixed Fly

-- Create ScreenGui
local gui = Instance.new("ScreenGui")
gui.Name = "UniversalUI"
gui.ResetOnSpawn = false
gui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 500, 0, 300)
mainFrame.Position = UDim2.new(0.5, -250, 0.5, -150)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.Visible = true
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = gui

local UICorner = Instance.new("UICorner", mainFrame)
UICorner.CornerRadius = UDim.new(0, 12)

-- Tab Buttons Holder
local tabHolder = Instance.new("Frame", mainFrame)
tabHolder.Size = UDim2.new(1, 0, 0, 40)
tabHolder.BackgroundTransparency = 1

local tabLayout = Instance.new("UIListLayout", tabHolder)
tabLayout.FillDirection = Enum.FillDirection.Horizontal
tabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
tabLayout.Padding = UDim.new(0, 8)

-- Container for tab contents
local contentFrame = Instance.new("Frame", mainFrame)
contentFrame.Size = UDim2.new(1, -20, 1, -60)
contentFrame.Position = UDim2.new(0, 10, 0, 50)
contentFrame.BackgroundTransparency = 1

-- Function to create tabs
local Tabs = {}
local function createTab(name)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 100, 1, 0)
    button.Text = name
    button.Font = Enum.Font.GothamBold
    button.TextSize = 14
    button.TextColor3 = Color3.fromRGB(220,220,220)
    button.BackgroundColor3 = Color3.fromRGB(40,40,40)
    button.Parent = tabHolder
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)

    local tabFrame = Instance.new("ScrollingFrame", contentFrame)
    tabFrame.Size = UDim2.new(1,0,1,0)
    tabFrame.Visible = false
    tabFrame.BackgroundTransparency = 1
    tabFrame.CanvasSize = UDim2.new(0,0,0,0)

    local layout = Instance.new("UIListLayout", tabFrame)
    layout.Padding = UDim.new(0,6)
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.SortOrder = Enum.SortOrder.LayoutOrder

    button.MouseButton1Click:Connect(function()
        for _,t in pairs(Tabs) do
            t.Frame.Visible = false
            t.Button.BackgroundColor3 = Color3.fromRGB(40,40,40)
        end
        tabFrame.Visible = true
        button.BackgroundColor3 = Color3.fromRGB(70,70,70)
    end)

    local tabData = {Button = button, Frame = tabFrame}
    table.insert(Tabs, tabData)
    if #Tabs == 1 then -- first tab default open
        tabFrame.Visible = true
        button.BackgroundColor3 = Color3.fromRGB(70,70,70)
    end
    return tabFrame
end

--// Tabs
local mainTab = createTab("Main")
local playerTab = createTab("Player")
local visualTab = createTab("Visuals")

--// Buttons Utility
local function createButton(tab, text, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.9,0,0,30)
    btn.Text = text
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.Parent = tab
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
    btn.MouseButton1Click:Connect(callback)
end

--// MAIN TAB
createButton(mainTab,"Rejoin",function()
    game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, game.Players.LocalPlayer)
end)

createButton(mainTab,"Server Hop",function()
    local HttpService = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    local servers = HttpService:JSONDecode(game:HttpGetAsync("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"))
    for _,s in pairs(servers.data) do
        if s.playing < s.maxPlayers then
            TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id)
            break
        end
    end
end)

--// PLAYER TAB
local noclip = false
createButton(playerTab,"Toggle Noclip",function()
    noclip = not noclip
end)
game:GetService("RunService").Stepped:Connect(function()
    if noclip and game.Players.LocalPlayer.Character then
        for _,v in pairs(game.Players.LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = not noclip
            end
        end
    end
end)

-- Fly System (from your script)
local isFlying = false
local flySpeed = 50
local bodyVelocity, bodyGyro
local flyConnection

local function startFlying()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")

    if not isFlying then
        isFlying = true
        humanoid.PlatformStand = true

        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = rootPart

        bodyGyro = Instance.new("BodyGyro")
        bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        bodyGyro.CFrame = rootPart.CFrame
        bodyGyro.Parent = rootPart

        flyConnection = game:GetService("RunService").RenderStepped:Connect(function()
            if isFlying and bodyVelocity and bodyGyro then
                local camera = workspace.CurrentCamera
                local moveDirection = Vector3.new(0, 0, 0)
                local uis = game:GetService("UserInputService")

                if uis:IsKeyDown(Enum.KeyCode.W) then
                    moveDirection += camera.CFrame.LookVector
                end
                if uis:IsKeyDown(Enum.KeyCode.S) then
                    moveDirection -= camera.CFrame.LookVector
                end
                if uis:IsKeyDown(Enum.KeyCode.A) then
                    moveDirection -= camera.CFrame.RightVector
                end
                if uis:IsKeyDown(Enum.KeyCode.D) then
                    moveDirection += camera.CFrame.RightVector
                end
                if uis:IsKeyDown(Enum.KeyCode.Space) then
                    moveDirection += Vector3.new(0,1,0)
                end
                if uis:IsKeyDown(Enum.KeyCode.LeftShift) then
                    moveDirection -= Vector3.new(0,1,0)
                end

                bodyVelocity.Velocity = moveDirection * flySpeed
                bodyGyro.CFrame = camera.CFrame
            end
        end)
    end
end

local function stopFlying()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChild("Humanoid")

    if isFlying then
        isFlying = false
        if humanoid then humanoid.PlatformStand = false end
        if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
        if bodyGyro then bodyGyro:Destroy() bodyGyro = nil end
        if flyConnection then flyConnection:Disconnect() flyConnection = nil end
    end
end

createButton(playerTab,"Toggle Fly",function()
    if isFlying then
        stopFlying()
    else
        startFlying()
    end
end)

--// VISUAL TAB (ESP)
local espEnabled = false
createButton(visualTab,"Toggle ESP",function()
    espEnabled = not espEnabled
    if espEnabled then
        for _,plr in pairs(game.Players:GetPlayers()) do
            if plr ~= game.Players.LocalPlayer and plr.Character then
                local highlight = Instance.new("Highlight")
                highlight.Name = "ESP_Highlight"
                highlight.FillTransparency = 0.7
                highlight.OutlineTransparency = 0
                highlight.FillColor = Color3.fromRGB(255,0,0)
                highlight.Adornee = plr.Character
                highlight.Parent = plr.Character

                local billboard = Instance.new("BillboardGui",plr.Character:WaitForChild("Head"))
                billboard.Name = "ESP_Tag"
                billboard.Size = UDim2.new(0,80,0,15)
                billboard.StudsOffset = Vector3.new(0,2,0)
                billboard.AlwaysOnTop = true

                local label = Instance.new("TextLabel",billboard)
                label.Size = UDim2.new(1,0,1,0)
                label.Text = plr.Name
                label.TextColor3 = Color3.fromRGB(255,255,255)
                label.Font = Enum.Font.GothamBold
                label.TextSize = 10
                label.BackgroundTransparency = 1
            end
        end
    else
        for _,plr in pairs(game.Players:GetPlayers()) do
            if plr.Character then
                if plr.Character:FindFirstChild("ESP_Highlight") then
                    plr.Character.ESP_Highlight:Destroy()
                end
                if plr.Character:FindFirstChild("Head") and plr.Character.Head:FindFirstChild("ESP_Tag") then
                    plr.Character.Head.ESP_Tag:Destroy()
                end
            end
        end
    end
end)

--// OPEN/CLOSE BUTTON
local toggleBtn = Instance.new("TextButton", gui)
toggleBtn.Size = UDim2.new(0,40,0,40)
toggleBtn.Position = UDim2.new(0,10,0.5,-20)
toggleBtn.Text = "â˜°"
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 20
toggleBtn.TextColor3 = Color3.new(1,1,1)
toggleBtn.BackgroundColor3 = Color3.fromRGB(30,30,30)
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0,8)

local open = true
toggleBtn.MouseButton1Click:Connect(function()
    open = not open
    mainFrame.Visible = open
end)
